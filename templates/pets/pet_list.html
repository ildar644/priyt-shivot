{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∏—Ç–æ–º—Ü—ã –∏–∑ –ø—Ä–∏—é—Ç–∞ - –ù–∞–π–¥–∏ –¥—Ä—É–≥–∞</title>
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêæ –ü–∏—Ç–æ–º—Ü—ã –∏–∑ –ø—Ä–∏—é—Ç–∞ –∏—â—É—Ç –¥–æ–º</h1>
            <p>–ü–æ–¥–∞—Ä–∏—Ç–µ –ª—é–±–æ–≤—å –∏ –∑–∞–±–æ—Ç—É –Ω–∞—à–∏–º —á–µ—Ç–≤–µ—Ä–æ–Ω–æ–≥–∏–º –¥—Ä—É–∑—å—è–º</p>
        </div>
        
        {% include 'includes/nav.html' %}
        
        <!-- –ü–∞–Ω–µ–ª—å —Å—Ä–∞–≤–Ω–µ–Ω–∏—è -->
        <div id="compare-panel" style="display: none;">
            <div class="compare-info">
                <span id="compare-count">0</span> –ø–∏—Ç–æ–º—Ü–µ–≤ –≤—ã–±—Ä–∞–Ω–æ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                <button id="compare-btn" class="btn-compare">–°—Ä–∞–≤–Ω–∏—Ç—å</button>
                <button id="clear-compare" class="btn-clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </div>

    {% if pets %}
        <div class="pets-grid">
            {% for pet in pets %}
                <div class="pet-card" data-pet-id="{{ pet.id }}">
                    <div class="pet-actions">
                        <input type="checkbox" class="compare-checkbox" value="{{ pet.id }}" id="compare-{{ pet.id }}">
                        <label for="compare-{{ pet.id }}" class="compare-label">–°—Ä–∞–≤–Ω–∏—Ç—å</label>
                        {% if user.is_authenticated %}
                            <button class="favorite-btn" data-pet-id="{{ pet.id }}" title="{% if pet.id in favorite_pet_ids %}–£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ{% else %}–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ{% endif %}">
                                {% if pet.id in favorite_pet_ids %}üíñ{% else %}‚ù§Ô∏è{% endif %}
                            </button>
                        {% endif %}
                    </div>
                    
                    <a href="{% url 'pet_detail' pet.pk %}">
                        {% if pet.photo %}
                            <img src="{{ pet.photo.url }}" alt="{{ pet.name }}">
                        {% else %}
                            <div class="no-photo">
                                <span>üì∑ –§–æ—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</span>
                            </div>
                        {% endif %}
                        <h3>{{ pet.name }}</h3>
                        <div class="pet-info">
                            <strong>–¢–∏–ø:</strong> <span>{{ pet.pet_type.name }}</span>
                        </div>
                        <div class="pet-info">
                            <strong>–í–æ–∑—Ä–∞—Å—Ç:</strong> <span>{{ pet.age_in_years }}</span>
                        </div>
                        <div class="pet-info">
                            <strong>–ü—Ä–∏—é—Ç:</strong> <span>{{ pet.shelter.name }}</span>
                        </div>
                    </a>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="no-pets">
            <h2>–ü–æ–∫–∞ –Ω–µ—Ç –ø–∏—Ç–æ–º—Ü–µ–≤ –¥–ª—è —É—Å—ã–Ω–æ–≤–ª–µ–Ω–∏—è</h2>
            <p>–î–æ–±–∞–≤—å—Ç–µ –ø–∏—Ç–æ–º—Ü–µ–≤ —á–µ—Ä–µ–∑ <a href="/admin/">–∞–¥–º–∏–Ω–∫—É</a></p>
        </div>
    {% endif %}
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–∏—Ç–æ–º—Ü–µ–≤
        const compareCheckboxes = document.querySelectorAll('.compare-checkbox');
        const comparePanel = document.getElementById('compare-panel');
        const compareCount = document.getElementById('compare-count');
        const compareBtn = document.getElementById('compare-btn');
        const clearCompareBtn = document.getElementById('clear-compare');
        
        let selectedPets = [];
        
        compareCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const petId = this.value;
                
                if (this.checked) {
                    if (selectedPets.length < 3) {
                        selectedPets.push(petId);
                    } else {
                        this.checked = false;
                        alert('–ú–æ–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏—Ç—å –º–∞–∫—Å–∏–º—É–º 3 –ø–∏—Ç–æ–º—Ü–µ–≤');
                        return;
                    }
                } else {
                    selectedPets = selectedPets.filter(id => id !== petId);
                }
                
                updateComparePanel();
            });
        });
        
        function updateComparePanel() {
            compareCount.textContent = selectedPets.length;
            
            if (selectedPets.length > 0) {
                comparePanel.style.display = 'block';
                compareBtn.disabled = selectedPets.length < 2;
            } else {
                comparePanel.style.display = 'none';
            }
        }
        
        compareBtn.addEventListener('click', function() {
            if (selectedPets.length >= 2) {
                const params = selectedPets.map(id => `pets=${id}`).join('&');
                window.location.href = `/compare/?${params}`;
            }
        });
        
        clearCompareBtn.addEventListener('click', function() {
            selectedPets = [];
            compareCheckboxes.forEach(cb => cb.checked = false);
            updateComparePanel();
        });
        
        // –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        const favoriteButtons = document.querySelectorAll('.favorite-btn');
        
        if (favoriteButtons.length > 0) {
            const csrfToken = '{{ csrf_token }}';
            
            favoriteButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const petId = this.dataset.petId;
                    
                    fetch(`/ajax/favorite/${petId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/json',
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        this.textContent = data.is_favorite ? 'üíñ' : '‚ù§Ô∏è';
                        this.title = data.message;
                    });
                });
            });
        }
    </script>
</body>
</html>
